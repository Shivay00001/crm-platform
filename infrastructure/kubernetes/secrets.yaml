# ============================================
# ConfigMap - Non-sensitive configuration
# ============================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: crm-config
  namespace: crm
data:
  # Application
  node-env: "production"
  api-version: "v1"
  
  # Redis
  redis-host: "redis-cluster.crm.svc.cluster.local"
  redis-port: "6379"
  cache-ttl: "3600"
  
  # Kafka
  kafka-brokers: "kafka-1.crm.svc.cluster.local:9092,kafka-2.crm.svc.cluster.local:9092,kafka-3.crm.svc.cluster.local:9092"
  kafka-client-id: "crm-backend"
  kafka-group-id: "crm-consumers"
  
  # Elasticsearch
  elasticsearch-node: "http://elasticsearch.crm.svc.cluster.local:9200"
  
  # S3 / Object Storage
  s3-region: "us-east-1"
  s3-bucket: "visionquantech-crm-prod"
  s3-endpoint: "https://s3.amazonaws.com"
  
  # Features
  enable-lead-dispatch: "true"
  enable-batch-processing: "true"
  enable-watchlist: "true"
  enable-analytics: "true"
  
  # Multi-Region
  primary-region: "us-east-1"
  enable-multi-region: "true"
  regions: "us-east-1,eu-west-1,ap-south-1"
  
  # Compliance
  data-retention-days: "2555"
  enable-audit-log: "true"
  enable-gdpr-mode: "true"
  
  # Rate Limiting
  rate-limit-window-ms: "60000"
  rate-limit-max-requests: "100"

---
# ============================================
# Secret - Sensitive credentials
# ============================================
# NOTE: In production, use external secret management
# (AWS Secrets Manager, GCP Secret Manager, HashiCorp Vault)
apiVersion: v1
kind: Secret
metadata:
  name: crm-secrets
  namespace: crm
type: Opaque
stringData:
  # Database credentials
  db-host: "postgres-primary.crm.svc.cluster.local"
  db-port: "5432"
  db-name: "crm_production"
  db-user: "crm_app_user"
  db-password: "CHANGE_IN_PRODUCTION"  # Use sealed-secrets or external secret manager
  
  # JWT tokens
  jwt-secret: "CHANGE_TO_RANDOM_64_CHAR_STRING"
  refresh-token-secret: "CHANGE_TO_RANDOM_64_CHAR_STRING"
  
  # S3 credentials
  s3-access-key: "YOUR_AWS_ACCESS_KEY"
  s3-secret-key: "YOUR_AWS_SECRET_KEY"
  
  # SMTP
  smtp-host: "smtp.gmail.com"
  smtp-port: "587"
  smtp-user: "noreply@visionquantech.com"
  smtp-password: "YOUR_SMTP_PASSWORD"
  
  # Twilio
  twilio-account-sid: "YOUR_TWILIO_SID"
  twilio-auth-token: "YOUR_TWILIO_TOKEN"
  twilio-phone-number: "+1234567890"
  
  # Supabase (optional)
  supabase-url: "https://your-project.supabase.co"
  supabase-service-role-key: "YOUR_SERVICE_ROLE_KEY"

---
# ============================================
# External Secrets Operator (Production)
# ============================================
# This example uses AWS Secrets Manager
# Install: helm install external-secrets external-secrets/external-secrets

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secretsmanager
  namespace: crm
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: crm-backend-sa

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: crm-secrets-external
  namespace: crm
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secretsmanager
    kind: SecretStore
  target:
    name: crm-secrets
    creationPolicy: Owner
  data:
  - secretKey: db-password
    remoteRef:
      key: crm/production/database
      property: password
  
  - secretKey: jwt-secret
    remoteRef:
      key: crm/production/jwt
      property: secret
  
  - secretKey: s3-access-key
    remoteRef:
      key: crm/production/s3
      property: access_key_id
  
  - secretKey: s3-secret-key
    remoteRef:
      key: crm/production/s3
      property: secret_access_key

---
# ============================================
# Sealed Secrets (Alternative)
# ============================================
# Install: kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml
# Create: kubeseal --format yaml < secret.yaml > sealed-secret.yaml

apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: crm-sealed-secrets
  namespace: crm
spec:
  encryptedData:
    db-password: AgBxxx...  # Encrypted value
    jwt-secret: AgByyy...   # Encrypted value
  template:
    metadata:
      name: crm-secrets
    type: Opaque

---
# ============================================
# Network Policies
# ============================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: crm-backend-netpol
  namespace: crm
spec:
  podSelector:
    matchLabels:
      app: crm-backend
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000
  
  # Allow from frontend
  - from:
    - podSelector:
        matchLabels:
          app: crm-frontend
    ports:
    - protocol: TCP
      port: 3000
  
  # Allow from workers
  - from:
    - podSelector:
        matchLabels:
          app: crm-workers
    ports:
    - protocol: TCP
      port: 3000
  
  egress:
  # Allow to PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  
  # Allow to Redis
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  
  # Allow to Kafka
  - to:
    - podSelector:
        matchLabels:
          app: kafka
    ports:
    - protocol: TCP
      port: 9092
  
  # Allow to Elasticsearch
  - to:
    - podSelector:
        matchLabels:
          app: elasticsearch
    ports:
    - protocol: TCP
      port: 9200
  
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
  
  # Allow HTTPS (for external APIs)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443